<app-header></app-header>

<div class="d-flex">
  <aside class="sidebar">
    <h5>مرحباً بك</h5>
    <ul class="mt-5">
      <li><a href="/modeer1">المخزن</a></li>
      <li class="active"><a>اذن الصرف</a></li>
      <li><a href="/modeer3">مذكرات الصرف</a></li>
      <li><a href="/modeer4">اذونات الصرف</a></li>
    </ul>
  </aside>

  <form *ngIf="consumableForm" [formGroup]="consumableForm" (ngSubmit)="onSubmit()" class="m-auto">
    <div class="form-container" dir="rtl">

      <header class="form-header">
        <h2 class="title">طلب و إذن صرف</h2>
        <h3 class="subtitle">مستديم | مستهلك</h3>
      </header>

      <div class="info-section">
        <div class="row">
          <div class="field mb-2">
            <label>اسم الجهة :</label>
            <input type="text" formControlName="destinationName" class="input-line">
          </div>

          <div class="field mb-2">
            <label>الفئة :</label>
            <select formControlName="category" class="table-input" (change)="onGlobalCategoryChange($event)">
              <option value="" disabled selected hidden>اختر الفئة</option>
              <option *ngFor="let category of allCategories" [value]="category">{{ category }}</option>
            </select>
          </div>
        </div>

        <div class="row">
          <div class="field mb-2 date-group">
            <label>تاريخ الطلب :</label>
        <input formControlName="requestDateGroup" type="date">
          </div>

          <div class="field d-flex align-items-center mb-2 date-group">
            <label>التاريخ :</label>
          <input formControlName="regularDateGroup" type="date">
          </div>

        <div class="row">
          <div class="field mb-2">
            <label>اسم الطالب ( المخزن / الإدارة / العامل ) :</label>
            <input type="text" formControlName="requestorName" class="input-line">
            <div *ngIf="consumableForm.get('requestorName')?.invalid && consumableForm.get('requestorName')?.touched"
              class="text-danger mt-1 text-end small">
              يجب إدخال الاسم كاملاً (4 كلمات).
            </div>
          </div>
        </div>

        <div class="row">
          <div class="field">
            <label>(*) سند الصرف :</label>
            <select formControlName="documentNumber" class="table-input">
              <option value="" disabled selected hidden>اختر السند</option>
              <option *ngFor="let condition of documentNumbers" [value]="condition">{{ condition }}</option>
            </select>
          </div>
        </div>
      </div>

      <div class="table-section">
        <table>
          <thead>
            <tr>
              <th>اسم الصنف</th>
              <th>الوحدة</th>
              <th>الكمية المطلوبة</th>
              <th>الكمية المصرح بها</th>
              <th>الكمية المنصرفة</th>
              <th>المخزن</th>
              <th>حالة الصنف (**)</th>
              <th>سعر الوحدة</th>
              <th>القيمة</th>
            </tr>
          </thead>
          <tbody formArrayName="tableData">
            <tr *ngFor="let rowGroup of tableData.controls; let i = index" [formGroupName]="i">

              <td>
                <input type="text" formControlName="itemSearchText" class="table-input" placeholder="ابحث عن صنف..."
                  [attr.list]="'list-' + i" (input)="filterItemOptions($event, i)" (blur)="syncItemName(i)">

                <!-- تعديل جديد: الأصناف تجي من DB حسب الفئة والفلاتر -->
                <datalist [id]="'list-' + i">
                  <option *ngFor="let item of filteredItemsByRow[i]" [value]="item">{{ item }}</option>
                </datalist>

                <input type="hidden" formControlName="itemName">
              </td>

              <!-- تعديل جديد: الوحدة وسعر الوحدة ممتلئ تلقائياً من DB -->
              <td><input type="text" formControlName="unit" class="table-input" readonly></td>
              <td><input type="number" min="0" formControlName="quantityRequired" class="table-input"></td>
              <td><input type="number" min="0" formControlName="quantityAuthorized" class="table-input"></td>
              <td><input type="number" min="0" formControlName="quantityIssued" class="table-input"></td>

              <td>
                <select formControlName="storeType" class="table-input">
                  <option value="" disabled selected hidden>اختر النوع</option>
                  <option *ngFor="let type of storeTypes" [value]="type">{{ type }}</option>
                </select>
              </td>

              <td>
                <select formControlName="itemCondition" class="table-input">
                  <option value="" disabled selected hidden>الحالة</option>
                  <option *ngFor="let condition of itemConditions" [value]="condition">{{ condition }}</option>
                </select>
              </td>

              <!-- تعديل جديد: سعر الوحدة ممتلئ تلقائياً من DB -->
              <td><input type="number" min="0" formControlName="unitPrice" class="table-input"></td>
              <td><input type="number" min="0" formControlName="value" class="table-input"></td>
            </tr>
          </tbody>
        </table>

        <div class="row-controls">
          <button type="button" class="remove-row-button" (click)="removeRow()">-</button>
          <button type="button" class="add-row-button" (click)="addRow()">+</button>
        </div>
      </div>

<div class="signature-section">
  <div class="sig-item">توقيع الطالب</div>
  <div class="sig-item">كاتب الشطب</div>

  <div class="sig-item approval-box">
    <span>يصرح بالصرف مدير المخازن</span>
    <input type="text" formControlName="managerSignature" class="signature-input">
    <div *ngIf="consumableForm.get('managerSignature')?.invalid
             && consumableForm.get('managerSignature')?.touched" class="error-text">
      الاسم كاملاً مطلوب.
    </div>
  </div>

  <div class="sig-item">تم الصرف أمين المخازن</div>
  <div class="sig-item">كاتب الشطب</div>
  <div class="sig-item">توقيع المستلم</div>
</div>


      <div class="footnotes">
        <p>(*) كشف العجز - سند خصم - أصناف تالفة أو تالفة - محضر بيع جلب تشغيل - إهداءات ليست للنشاط الرئيسي للجهة</p>
        <p>(**) جديدة - مستعمل - قابل للإصلاح - كهنة أو خردة</p>
      </div>

      <div class="button-section">
        <button type="submit" [disabled]="isSubmitting() || consumableForm.invalid"
          class="submit-btn text-white fw-medium p-3 fs-5">
          <span *ngIf="isSubmitting()">جاري الحفظ...</span>
          <span *ngIf="!isSubmitting()">حفظ الاذن</span>
        </button>
      </div>

    </div>

    </div>
  </form>

</div>
<app-footer>

</app-footer>
