<app-header></app-header>

<div class="content d-flex flex-row">
  <aside class="sidebar">
    <h5>مرحبًا بك</h5>

    <ul class="mt-5">
      <li><a href="/modeer1">المخزن</a></li>
      <li><a href="/modeer2">اذن الصرف</a></li>
      <li><a href="/modeer3">مذكرات الصرف</a></li>
      <li><a href="/modeer4">اذونات الصرف</a></li>
      <li class="active"><a>الجرد</a></li>
    </ul>
  </aside>

  <div class="big-container  m-5 flex-grow-1">
    <div class="form-container" dir="rtl">
      <header class="form-header">
        <h2 class="title">كشف جرد المخزن</h2>
        <h3 class="subtitle">مطابقة الرصيد الفعلي والدفتري</h3>
      </header>

      <!-- Filters -->
      <div class="filter-bar mb-4 d-flex align-items-center gap-3 flex-wrap">

        <!-- عرض -->
        <div class="d-flex align-items-center gap-2 border-end pe-3">
          <label class="fw-bold">عرض:</label>
          <select class="form-select shadow-sm" [(ngModel)]="viewMode" (change)="onViewModeChange()">
            <option value="live">الحالة الحالية (اليوم)</option>
            <option value="history">سجلات سابقة</option>
          </select>
        </div>

        <!-- نوع الجرد -->
        <div class="d-flex align-items-center gap-2 border-end pe-3" *ngIf="viewMode === 'history'">
          <label class="fw-bold">نوع الجرد:</label>
          <select class="form-select shadow-sm" [(ngModel)]="auditMode" (change)="onAuditModeChange()">
            <option value="range">فترة زمنية</option>
            <option value="single">يوم معين</option>
          </select>
        </div>

        <!-- فترة زمنية -->
        <div class="d-flex align-items-center gap-2 border-end pe-3"
          *ngIf="viewMode === 'history' && auditMode === 'range'">
          <label class="fw-bold">من:</label>
          <input type="date" class="form-control shadow-sm" [(ngModel)]="startDate" (change)="onDateChange()" />

          <label class="fw-bold">إلى:</label>
          <input type="date" class="form-control shadow-sm" [(ngModel)]="endDate" (change)="onDateChange()" />
          <!-- رسالة الخطأ -->
          <div *ngIf="endDateError" class="text-danger small mt-1">
            {{ endDateError }}
          </div>
        </div>

        <!-- يوم معين -->
        <div class="d-flex align-items-center gap-2 border-end pe-3"
          *ngIf="viewMode === 'history' && auditMode === 'single'">
          <label class="fw-bold">اليوم:</label>
          <input type="date" class="form-control shadow-sm" [(ngModel)]="singleDate" (change)="onSingleDateChange()" />
        </div>

        <!-- الفئة -->
        <div class="d-flex align-items-center gap-2 flex-grow-1">
          <label class="fw-bold">الفئة</label>
          <select class="form-select w-60 shadow-sm" [(ngModel)]="selectedCategory" (change)="applyFilter()"
            [disabled]="categories.length === 0">
            <option value="الكل">جميع الفئات</option>
            <option *ngFor="let cat of categories" [value]="cat">
              {{ cat }}
            </option>
          </select>
        </div>

        <!-- إحصائية -->
        <div class="stats-badge">
          <span>إجمالي الأصناف:</span>
          <span class="count">{{ filteredInventory.length }}</span>
        </div>
      </div>

      <!-- Info -->
      <div class="info-section">
        <div class="row">
          <div class="field mb-2">
            <label>التاريخ :</label>

            <span *ngIf="viewMode === 'live'">
              {{ today | date : 'fullDate' }}
            </span>

            <span *ngIf="viewMode === 'history' && auditMode === 'range' && startDate && endDate">
              من {{ startDate }} إلى {{ endDate }}
            </span>

            <span *ngIf="viewMode === 'history' && auditMode === 'single' && singleDate">
              حتى تاريخ {{ singleDate }}
            </span>
          </div>

          <div class="field mb-2">
            <label>القائم بالجرد :</label>
            <span>{{ fullName }}</span>
          </div>
        </div>
      </div>

      <div class="d-md-none text-center text-muted mb-2 small">
  <i class="fas fa-arrows-alt-h"></i> اسحب الجدول يميناً ويساراً لمشاهدة كافة البيانات
</div>

      <!-- Table -->
      <div class="table-section custom-scrollbar">
        <table>
          <thead>
            <tr>
              <th>اسم الصنف</th>
              <th>الوحدة</th>
              <th>الكمية الكلية</th>
              <th *ngIf="viewMode === 'history'">كمية الوارد</th>
              <th>الكمية المنصرفة</th>
              <th>الكمية المتبقية</th>
              <th>العجز</th>
              <th>الفئة</th>
              <th>نوع الصنف</th>
            </tr>
          </thead>

          <tbody>
            <tr *ngFor="let item of filteredInventory" [ngClass]="getRowClass(item)">

              <td class="fw-bold">{{ item.itemName }}</td>
              <td>{{ item.unit }}</td>
              <td>{{ item.totalQuantity }}</td>

              <td *ngIf="viewMode === 'history'">
                {{ item.incomingQuantity }}
              </td>

              <td>{{ item.issuedQuantity }}</td>
              <td>{{ item.remainingQuantity }}</td>

              <td [ngClass]="{ 'text-danger fw-bold': getDeficit(item) > 0 }">
                {{ getDeficit(item) }}
              </td>

              <td>
                <span class="category-pill">{{ item.category }}</span>
              </td>

              <td>
                <span [ngClass]="{
                    'badge-permanent': item.itemType === 'مستديم',
                    'badge-consumable': item.itemType === 'مستهلك'
                  }">
                  {{ item.itemType }}
                </span>
              </td>
            </tr>

            <tr *ngIf="filteredInventory.length === 0">
              <td [attr.colspan]="viewMode === 'history' ? 9 : 8" class="text-center py-4 text-muted">
                لا توجد بيانات
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>
