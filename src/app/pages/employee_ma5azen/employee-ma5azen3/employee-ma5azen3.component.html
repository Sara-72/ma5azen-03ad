<app-header></app-header>

<div *ngIf="statusMessage" class="status-overlay">
  <div class="status-box" [ngClass]="statusType">
    <div class="mb-3" style="font-size: 4rem">
      {{ statusType === "success" ? "✅" : "❌" }}
    </div>

    <h3
      class="fw-bold mb-3"
      [style.color]="statusType === 'success' ? '#28a745' : '#dc3545'"
    >
      {{ statusType === "success" ? "تمت العملية" : "تنبيه" }}
    </h3>

    <p class="fs-5 text-dark">
      {{ statusMessage }}
    </p>

    <button type="button" class="close-btn" (click)="closeStatusMessage()">
      موافق
    </button>
  </div>
</div>

<div class="content d-flex flex-row">
  <aside class="sidebar">
    <h5>
      مرحبًا بك
      <span *ngIf="displayName">، {{ displayName }}</span>
    </h5>
    <ul class="mt-5">
      <li><a href="/employee_ma5azen1">دفتر المالية</a></li>
      <li><a href="/employee_ma5azen2">كاتب الشطب</a></li>
      <li class="active"><a>المخزن</a></li>
      <li><a href="/employee_ma5azen4">مخزن الأمين</a></li>
      <li><a href="/employee_ma5azen5">عرض مخزنك </a></li>
    </ul>
  </aside>

  <form
    [formGroup]="simpleForm"
    (ngSubmit)="onSubmit()"
    dir="rtl"
    class="mt-5 form-part m-auto flex-grow-1 d-flex flex-column align-items-center"
  >
    <div class="table-section">
      <h2 class="text-center">المخزن</h2>

      <div class="table-outer-wrapper">
        <div class="table-responsive custom-scrollbar">
          <table class="table table-bordered text-center">
            <thead>
              <tr>
                <th>الفئة</th>
                <th>الصنف</th>
                <th>حالة الصنف</th>
                <th>الوحدة</th>
                <th>العدد</th>
                <th>التاريخ</th>
              </tr>
            </thead>

            <tbody formArrayName="tableData">
              @for (rowGroup of tableData.controls; track $index) {
              <tr [formGroupName]="$index">

                <!-- ===== CATEGORY ===== -->
                <td>
                  <input
  *ngIf="!isManualCategory[$index]"
  type="text"
  formControlName="category"
  class="form-control"
  list="categoryOptions"
  placeholder="ابحث عن فئة..."
  (change)="onCategoryChange($any($event.target).value, $index)"
/>

                  <input
                    *ngIf="isManualCategory[$index]"
                    type="text"
                    formControlName="category"
                    class="form-control"
                    placeholder="اكتب فئة جديدة"
                  />

                  <datalist id="categoryOptions">
                    @for (category of categories; track category) {
                    <option [value]="category"></option>
                    }
                  </datalist>

                  @if (rowGroup.get('category')?.errors?.['invalidCategory'] &&
                  rowGroup.get('category')?.touched) {
                  <div class="text-danger small mt-1">هذه الفئة غير موجودة</div>
                  }
                </td>


                <!-- ===== ITEM ===== -->
                <td>
                  <input
                    *ngIf="!isManualItem[$index]"
                    type="text"
                    formControlName="item"
                    class="form-control"
                    [attr.list]="'itemOptions' + $index"
                    placeholder="ابحث عن صنف..."
                    (change)="onItemChange($any($event.target).value, $index)"

                  />

                  <input
                    *ngIf="isManualItem[$index]"
                    type="text"
                    formControlName="item"
                    class="form-control"
                    placeholder="اكتب صنف جديد"
                  />

                  <datalist [id]="'itemOptions' + $index">
                    @for (item of availableItemsByRow[$index]; track item) {
                    <option [value]="item"></option>
                    }
                  </datalist>

                  @if (rowGroup.get('item')?.errors?.['invalidItem'] &&
                  rowGroup.get('item')?.touched) {
                  <div class="text-danger small mt-1">
                    هذا الصنف غير متاح لهذه الفئة
                  </div>
                  }
                </td>

                <!-- ===== ITEM TYPE ===== -->
                  <td>
                  <select formControlName="itemType" class="form-control">
                    <option value="" disabled hidden>اختر نوع</option>
                    @for (type of itemTypes; track type) {
                    <option [value]="type">{{ type }}</option>
                    }
                  </select>
                </td>

                <!-- ===== UNIT ===== -->
                <td>
                  <input
                    *ngIf="!isManualUnit[$index]"
                    type="text"
                    formControlName="unit"
                    class="form-control"
                    list="unitOptions"
                    placeholder="الوحدة..."
                    (change)="onUnitChange($any($event.target).value, $index)"

                  />

                  <input
                    *ngIf="isManualUnit[$index]"
                    type="text"
                    formControlName="unit"
                    class="form-control"
                    placeholder="اكتب وحدة جديدة"
                  />

                  <datalist id="unitOptions">
                    @for (u of units; track u) {
                    <option [value]="u"></option>
                    }
                  </datalist>

                  @if (rowGroup.get('unit')?.errors?.['invalidUnit'] &&
                  rowGroup.get('unit')?.touched) {
                  <div class="text-danger small mt-1">هذه الوحدة غير مسجلة</div>
                  }
                </td>
                <!-- ===== COUNT ===== -->
                 <td>
                  <input
                    type="number"
                    formControlName="count"
                    class="form-control"
                  />
                </td>

                <!-- ===== DATE ===== -->
                <td>
                  <input
                    type="date"
                    formControlName="entryDate"
                    class="form-control bg-light"
                  />
                </td>
              </tr>
              }
            </tbody>
          </table>
        </div>
      </div>

      <button type="button" class="remove-row-button" (click)="removeRow()">-</button>
      <button type="button" class="add-row-button" (click)="addRow()">+</button>
    </div>

    <button
      type="submit"
      [disabled]="isSubmitting() || simpleForm.invalid"
      class="submit-btn mt-5"
    >
      @if (isSubmitting()) { جاري الحفظ... } @else { حفظ البيانات }
    </button>
  </form>
</div>
