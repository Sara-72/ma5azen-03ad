<app-header></app-header>

<div *ngIf="statusMessage" class="modal-overlay">
  <div class="modal-box" [ngClass]="statusType">
    <div class="icon">
      {{ statusType === "success" ? "✅" : "❌" }}
    </div>
    <h3 [style.color]="statusType === 'success' ? '#28a745' : '#dc3545'">
      {{ statusType === "success" ? "تمت العملية" : "تنبيه" }}
    </h3>
    <p>{{ statusMessage }}</p>
    <button class="confirm-btn" (click)="closeStatusMessage()">موافق</button>
  </div>
</div>

<div class="content d-flex flex-row">
  <aside class="sidebar">
    <h5>مرحبًا بك <span *ngIf="displayName">، {{ displayName }}</span></h5>
    <ul class="mt-5">
      <li class="active"><a>دفتر المالية</a></li>
      <li><a href="/employee_ma5azen2">كاتب الشطب</a></li>
      <li><a href="employee_ma5azen3">المخزن</a></li>
      <li><a href="/employee_ma5azen4">مخزن الأمين</a></li>
      <li><a href="/employee_ma5azen5">عرض مخزنك </a></li>
    </ul>
  </aside>

  <main class="flex-grow-1">
    <form [formGroup]="inventoryLogForm" (ngSubmit)="onSubmit()" dir="rtl" class="my-5 mx-4">
      <div class="table-section">
        <h2 class="text-center">دفتر المالية</h2>

        <div class="table-responsive custom-scrollbar">
          <table class="table table-bordered text-center">
            <thead>
              <tr>
                <th>رقم الإضافة</th>
                <th>اسم الصنف</th>
                <th>الوحدة</th>
                <th>الكمية</th>
                <th>سعر الوحدة</th>
                <th>القيمة</th>
                <th>حالة الصنف</th>
              </tr>
            </thead>

            <tbody formArrayName="tableData">
              <tr *ngFor="let rowGroup of tableData.controls; let i = index" [formGroupName]="i">
                <td>
                  <input type="number" formControlName="additionNumber" class="form-control text-center" />
                </td>

<td class="dropdown-cell" style="position: relative; overflow: visible !important;">


  <input
    type="text"
    class="form-control text-center"
    formControlName="itemName"
    placeholder="اكتب اسم الصنف"
    (input)="filterItems(tableData.at(i).get('itemName')?.value, i)"
    (change)="onItemChange(i)"
  />

  <ul *ngIf="filteredItems[i]?.length" class="floating-dropdown">
    <li class="list-group-item" *ngFor="let item of filteredItems[i]" (click)="selectItem(item, i)">
      {{ item }}
    </li>
    <li class="list-group-item" style="color:var(--secondary-color)" (click)="selectOther(i)">
      <span class="fw-bold" style="color: var(--secondary-color);">+</span> أخرى
    </li>
  </ul>
  <div *ngIf="(tableData.at(i).get('itemName')?.invalid && tableData.at(i).get('itemName')?.touched) || isFormSubmitted()" class="text-danger small">
   الرجاء إدخال اسم الصنف
</div>
</td>

                <td><input type="text" formControlName="unit" class="form-control text-center" /></td>
                <td><input type="number" formControlName="quantity" class="form-control text-center" /></td>
                <td><input type="number" formControlName="unitPrice" class="form-control text-center" /></td>
                <td><input type="number" formControlName="value" class="form-control text-center" /></td>
                <td>
                  <select formControlName="itemCondition" class="form-select text-center">
                    <option value="" disabled>اختر</option>
                    <option value="مستهلك">مستهلك</option>
                    <option value="مستديم">مستديم</option>
                  </select>
                </td>
              </tr>
            </tbody>
          </table>
        </div>

        <button type="button" class="remove-row-button" (click)="removeRow()">-</button>
        <button type="button" class="add-row-button" (click)="addRow()">+</button>
      </div>

      <div class="button-section text-center">
        <button type="submit" [disabled]="isSubmitting()" class="submit-btn mt-5">
          {{ isSubmitting() ? "جاري الحفظ..." : "حفظ البيانات" }}
        </button>
      </div>
    </form>
  </main>
</div>
