<app-header></app-header>



<div *ngIf="statusMessage" class="status-overlay">
  <div class="status-box" [ngClass]="statusType">

    <div class="mb-3" style="font-size: 4rem;">
       {{ statusType === 'success' ? '✅' : '❌' }}
    </div>

    <h3 class="fw-bold mb-3" [style.color]="statusType === 'success' ? '#28a745' : '#dc3545'">
       {{ statusType === 'success' ? 'تمت العملية' : 'تنبيه' }}
    </h3>

    <p class="fs-5 text-dark">
      {{ statusMessage }}
    </p>

    <button class="close-btn" (click)="closeStatusMessage()">موافق</button>
  </div>
</div>

<div class="page-container">
  <aside class="sidebar">
    <h5>  مرحبًا بك</h5>
    <span *ngIf="displayName">، {{ displayName }}</span>
    <ul class="mt-5">
      <li><a href="/ameen1">المخزن</a></li>
      <li><a href="/ameen2">دفتر اليومية</a></li>
      <li class="active"><a>أذونات الصرف</a></li>
      <li><a href="/ameen4">دفاتر اليومية</a></li>
      <li><a href="/ameen5">مخزنك</a></li>
      <li><a href="/ameen6">الجرد</a></li>
      <li><a href="/ameen7">عهد الموظفين</a></li>
    </ul>
  </aside>

  <div class="big-container m-auto">
     <!-- لا يوجد أذونات -->
<div *ngIf="!hasPermissions()" class="no-data-wrapper">
    <div class="text-center">
        <i class="fas fa-clipboard-list d-block mb-3 empty-icon m-auto"></i>
        <p class="m-auto fw-bold fs-4 text-muted">لا توجد أذونات صرف حالياً.</p>
    </div>
</div>
    <div *ngFor="let perm of groupedPermissions" class="form-container mb-5" dir="rtl">

      <header class="form-header">
        <h2 class="title">طلب و إذن صرف</h2>
        <h3 class="subtitle">مستديم | مستهلك</h3>
      </header>


      <div class="info-section">
      <div class="info-section">
        <div class="row">
          <div class="field mb-2">
            <label>اسم الجهة :</label>
            <span>{{ perm.destinationName }}</span>
          </div>
          <div class="field mb-2">
            <label>الفئة :</label>
            <span>{{ perm.category }}</span>
          </div>
        </div>

        <div class="row">
          <div class="field mb-2 date-group">
            <label>تاريخ الطلب :</label>
            <span>{{ perm.requestDate | date:'shortDate' }}</span>
          </div>
          <div class="field mb-2 date-group">
            <label>تاريخ الإذن :</label>
            <span>{{ perm.documentDate | date:'shortDate' }}</span>
          </div>
          <div class="field mb-2 date-group">
  <label>تاريخ الصرف :</label>
  <span>{{ today | date:'shortDate' }}</span>
</div>

        </div>

        <div class="row">
          <div class="field mb-2">
            <label>اسم الطالب ( المخزن / الإدارة / العامل ) :</label>
            <span>{{ perm.requestorName }}</span>
          </div>
        </div>

        <div class="row">
          <div class="field mb-2">
            <label>(*) سند الصرف :</label>
            <span>{{ perm.documentNumber }}</span>
          </div>
        </div>
      </div>

      <div class="table-section">
        <table>
          <thead>
            <tr>
              <th>اسم الصنف</th>
              <th>الوحدة</th>
              <th>الكمية المطلوبة</th>
              <th>الكمية المصرح بها</th>
              <th>الكمية المنصرفة</th>
              <th>المخزن</th>
              <th>حالة الصنف (**)</th>
              <th>سعر الوحدة</th>
              <th>القيمة</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let item of perm.items">
              <td>{{ item.itemName }}</td>
              <td>{{ item.unit }}</td>
              <td>{{ item.requestedQuantity }}</td>
              <td>{{ item.approvedQuantity }}</td>
              <td>{{ item.issuedQuantity }}</td>
              <td>{{ item.storeHouse }}</td>
              <td>{{ item.stockStatus }}</td>
              <td>{{ item.unitPrice }}</td>
              <td>{{ item.totalValue }}</td>
            </tr>
          </tbody>
        </table>
      </div>

      <div class="signature-section">
        <div>توقيع الطالب</div>
        <div>كاتب الشطب</div>
        <div class="d-flex flex-column">
          <div>يصرح بالصرف مدير المخازن</div>
          <span>{{ perm.managerSignature }}</span>
        </div>
        <div>
          <div style="white-space:nowrap">تم الصرف أمين المخازن</div>
          <span>{{ fullName }}</span>

        </div>

        <div>كاتب الشطب</div>
        <div>توقيع المستلم</div>
      </div>

      <div class="footnotes">
        <p>(*) كشف العجز - سند خصم - أصناف تالفة أو تالفة - محضر بيع جلب تشغيل - إهداءات ليست للنشاط الرئيسي للجهة</p>
        <p>(**) جديدة - مستعمل - قابل للإصلاح - كهَن أو خردة</p>
      </div>

      <hr>

      <div class="my-2">
        <button *ngIf="confirmingPerm !== perm" type="button" class="btn btn-success" (click)="openConfirmInline(perm)">
           قبول اذن الصرف
        </button>

        <div *ngIf="confirmingPerm === perm" class="d-flex align-items-center justify-content-between">
          <p class="fw-bold" style="color:var(--primary-color)">هل أنت متأكد من قبول إذن الصرف؟</p>
          <div class="d-flex gap-3">

            <button type="button" class="btn btn-primary mx-2" (click)="confirmApprove()">تأكيد</button>
            <button class="btn btn-warning" (click)="cancelConfirm()">تراجع</button>

          </div>
        </div>
      </div>

    </div>
  </div>
</div>

</div>

